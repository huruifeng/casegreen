{% extends "mycase_basic.html" %}
{% load static %}
{% block content %}
    <div class="container-fluid pt-3" style="width: 90%;min-width: 1200px;">
        <div class="row">
            <div class="col-md-1 text-center" style="margin-left: 10px;width: 150px;">
                <img class="img-fluid" id="logo-img" src={% static "mycase/img/mycase_logo_short.png" %} style="max-width:180px;max-height:45px;">
            </div>
            <div class="col-md-6" style="min-width:800px;max-width: 820px;">
              <form action="/mycase" method="get">
                <div class="input-group">
                  <div class="form-outline flex-fill">
                    <input type="search" id="receipt_number" name="receipt_number" class="form-control form-control-lg" style="color: black;" value="{{ receipt_num }}" />
                    <label class="form-label" for="form1">Enter you receipt number</label>
                  </div>
                  <button type="submit" class="btn btn-primary" style="box-shadow: none;">
                    <i class="fas fa-search"></i>&nbsp;&nbsp;&nbsp;&nbsp;Search
                  </button>
                </div>
              </form>

            </div>
        </div>
        <br>
         <div class="row">
             <div class="col-md-1 text-center" style="margin-left: 10px;width: 150px;"> </div>
             <div class="col-md-6" style="min-width: min-content;">
                 <!-- Case status -->
                 <div class="row" style="max-width: 820px;">
                     <div class="col-12">
{#                             <h3 style="color:green;">Case Was Approved</h3>#}
                         <h4 style="color:#2d48cb;">{{ status.status}}</h4>
                        <input type="hidden" name="temp_form" id="temp_form" value="{{ status.form }}">
                         {% if status.form != "" %}
                            <span>Form: {{ status.form}}</span>
                         {% else %}
                             <span>Form:
                                 <select>
                                     <option value="" selected></option>
                                     {% for form_i in form_ls %}
                                     <option value="{{ form_i }}">{{ form_i }}</option>
                                     {% endfor %}

                                 </select>
                             </span>
                         {% endif %}&nbsp;&nbsp;&nbsp;&nbsp;
                         <span>Last update on: {{ status.date}} ({{ status.days }} days ago)</span>
                         <hr style="height: 1px;color: #666666">
                         <p>
                            {{ status.status_text|safe }}
                         </p>
                     </div>
                 </div>
                 <!-- End of Case status -->
                 <hr style="height: 0.2px;color: #ccc;max-width: 820px;">
                 <!-- Case history & Case range pie-->
                  <div class="row row-cols-2" style="max-width: 820px;">
                     <div class="col-md-6">
                         <h5 class="mb-3"><i class="fa-solid fa-list-check text-primary"></i>&nbsp;&nbsp;<strong>Case history</strong></h5>
                         <!-- Section: Timeline -->
                         <section style="padding-left: 30px;">
                            <style>
                              .timeline-with-icons {
                                border-left: 1px solid hsl(0, 0%, 90%);
                                position: relative;
                                list-style: none;
                              }

                              .timeline-with-icons .timeline-item {
                                position: relative;
                              }

                              .timeline-with-icons .timeline-item:after {
                                position: absolute;
                                display: block;
                                top: 0;
                              }

                              .timeline-with-icons .timeline-icon {
                                position: absolute;
                                left: -43px;
                                border-radius: 50%;
                                height: 21px;
                                width: 21px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                              }

                              .timeline-icon-blue {
                                background-color: hsl(217, 88.2%, 90%);
                                color: hsl(217, 88.8%, 35.1%);
                              }

                              .timeline-icon-yellow {
                                background-color: hsl(63, 92%, 67%);
                                color: hsl(62, 98%, 36%);
                              }

                              .timeline-icon-red {
                                background-color: hsla(0, 92%, 85%, 0.45);
                                color: hsl(1, 96%, 44%);
                              }

                              .timeline-icon-green {
                                background-color: hsl(97, 88%, 90%);
                                color: hsl(110, 92%, 33%);
                              }

                            </style>

                            <ul class="timeline-with-icons">

                                {% for qs_i in status_qs %}
                                    <li class="timeline-item mb-md-5">
                                            {% if qs_i.case_stage == "Processing" %}
                                                <span class="timeline-icon timeline-icon-blue"><i class="fa-solid fa-check fa-sm fa-fw"></i></span>
                                            {% elif qs_i.case_stage == "RFE" %}
                                                <span class="timeline-icon timeline-icon-yellow"><i class="fa-solid fa-arrow-rotate-left fa-fw fa-sm"></i></span>
                                            {% elif qs_i.case_stage == "Rejected" %}
                                                <span class="timeline-icon timeline-icon-red"><i class="fa-solid fa-xmark fa-sm fa-fw"></i></span>
                                            {% elif qs_i.case_stage == "Approved" %}
                                                <span class="timeline-icon timeline-icon-green"><i class="fa-regular fa-id-card fa-sm fa-fw"></i></span>
                                            {% else %}
                                                <span class="timeline-icon timeline-icon-blue"> <i class="fa-solid fa-check fa-sm fa-fw"></i></span>
                                            {% endif %}
                                        <h6>{{ qs_i.status }} </h6>
                                        <p class="text-muted mb-2">{{ qs_i.action_date }}&nbsp;&nbsp;&nbsp;&nbsp;({{ qs_i.action_days_to_now }} days)</p>

                                    </li>
                                {% endfor %}

                            </ul>
                         </section>
                         <!-- Section: Timeline -->
                     </div>
                      <div class="col-md-6" style="border-left: #eee 0.2px solid;">
                          <h5 class="mb-3"><i class="fa-solid fa-chart-pie text-primary"></i>&nbsp;&nbsp;<b>Cases in the range</b>(<span class="n_cases">#</span> Cases)</h5>
                          <h4 class="na_h4 d-none ms-5">No data is available currently!</h4>
                          <div id="donut_chart">
                                <canvas id="donut_case_percent_in_range" style="max-height: 400px;min-height: 300px;min-width: 300px;"></canvas>
                          </div>
                      </div>
                 </div>
                 <!-- End of Case history & Case range pie -->
                 <hr style="height: 0.2px;color: #ccc;max-width: 820px;">
                  <!-- my position -->
                 <div class="row"  style="max-width: 840px;">
                     <div class="col-12">
                         <h5 class="mb-3"><i class="fa-solid fa-location-dot text-primary"></i>&nbsp;&nbsp;<strong>My position</strong></h5>
                         <div id="myposition_wrapper">
                         <div class="mb-3">Based on cases in the range:
                             <select id="case_range" name="case_range" onchange="get_data()">
                                 <option value="rn_range" selected>ReceiptNumber: {{ case_range }}</option>
                                 <option value="rn_n200">You ReceiptNumber - 200</option>
                                 <option value="rn_n500">You ReceiptNumber - 500</option>
                                 <option value="rn_n1000">You ReceiptNumber - 1000</option>
                                 <option value="rn_p200">You ReceiptNumber + 200</option>
                                 <option value="rn_p500">You ReceiptNumber + 500</option>
                                 <option value="rn_p1000">You ReceiptNumber + 1000</option>
                                 <option value="rn_np200">You ReceiptNumber &plusmn; 200</option>
                                 <option value="rn_np500">You ReceiptNumber &plusmn; 500</option>
                                 <option value="rn_np1000">You ReceiptNumber &plusmn; 1000</option>
                                 <option value="rd_n1m">Your RD and Your RD - 1 month</option>
                                 <option value="rd_n2m">Your RD and Your RD - 2 month</option>
                                 <option value="rd_n3m">Your RD and Your RD - 3 month</option>
                                 <option value="rd_p1m">Your RD and Your RD + 1 month</option>
                                 <option value="rd_p2m">Your RD and Your RD + 2 month</option>
                                 <option value="rd_p3m">Your RD and Your RD + 3 month</option>
                                 <option value="rd_np1m">Your case RD &plusmn; 1 month</option>
                                 <option value="rd_np2m">Your case RD &plusmn; 2 month</option>
                                 <option value="rd_np3m">Your case RD &plusmn; 3 month</option>
                            {#   <option value="rn_fy">All cases received in YOUR Fiscal Year</option>#}
                             </select>
                            <span>(Same case type/Same form type)</span>
                         </div>

                         <h6><b><i class="fa-solid fa-diamond"></i> Cases in order of Receipt Number</b>(<span class="n_cases">#</span> Cases)</h6>
                             <h4 class="na_h4 d-none ms-5">No data is available currently!</h4>
                         <div class="card" id="myposition_RN_order">
                              <div class="card-body p-0 ps-3">
                                  <param id="statu_sequence" value="AAAAAAAAAAAAORRFFFFEFFFFFFFFFRRFFF" />
                                  <param id="recepit_num" value="{{ receipt_num }}" />
                                  <param id="form_type" value="{{ status.form }}" />
                                  <div class="row">
                                      <div class="col-md-12">
                                          <div id="controlpanel" class="col-md-4" style="width:100%;">
                                              <div style="font:12px Verdana;font-weight:bold;">Show cases: </div>
                                              <div style="font:14px Verdana;">
                                                  <div class="form-check form-check-inline">
                                                      <input class="form-check-input" type="checkbox" name="status_type_lollipop" id="REC_box" value="REC" />
                                                      <label class="form-check-label" for="REC_box">Received</label>
                                                  </div>
                                                  <div class="form-check form-check-inline">
                                                      <input class="form-check-input" type="checkbox" name="status_type_lollipop" id="FP_box" value="FP" />
                                                      <label class="form-check-label" for="FP_box">Figureprinted</label>
                                                  </div>
                                                  <div class="form-check form-check-inline">
                                                      <input class="form-check-input" type="checkbox" name="status_type_lollipop" id="ITV_box" value="ITV" />
                                                      <label class="form-check-label" for="ITV_box">Interviewed</label>
                                                  </div>
                                                  <div class="form-check form-check-inline">
                                                      <input class="form-check-input" type="checkbox" name="status_type_lollipop" id="RFE_box" value="RFE" />
                                                      <label class="form-check-label" for="RFE_box">RFE</label>
                                                  </div>
                                                  <div class="form-check form-check-inline">
                                                      <input class="form-check-input" type="checkbox" name="status_type_lollipop" id="TRF_box" value="TRF" />
                                                      <label class="form-check-label" for="TRF_box">Transferred</label>
                                                  </div>
                                                  <div class="form-check form-check-inline">
                                                      <input class="form-check-input" type="checkbox" name="status_type_lollipop" id="APV_box" value="APV" />
                                                      <label class="form-check-label" for="APV_box">Approved</label>
                                                  </div>
                                                  <div class="form-check form-check-inline">
                                                      <input class="form-check-input" type="checkbox" name="status_type_lollipop" id="RJC_box" value="RJC" />
                                                      <label class="form-check-label" for="RJC_box">Rejected</label>
                                                  </div>
                                                  <div class="form-check form-check-inline">
                                                      <input class="form-check-input" type="checkbox" name="status_type_lollipop" id="OTH_box" value="OTH" />
                                                      <label class="form-check-label" for="OTH_box">Other</label>
                                                  </div>
                                                   <div class="form-check form-check-inline">
                                                      <input class="form-check-input" type="checkbox" name="status_type_lollipop" id="ME_box" value="ME" checked />
                                                      <label class="form-check-label" for="ME_box">Me</label>
                                                  </div>
                                              </div>
                                              <div style="">
                                                <div id="lollipop_legend"></div>
                                              </div>
                                        </div>
                                        <!-- control pannel -->
                                      </div>
                                      <!-- col-md-4 -->
                                  </div>
                                  <div class="row" style="max-width:820px;">
                                      <div class="col-md-12" >
                                          <div id="case_in_receipt_order"  style="height:125px;"></div>
                                      </div>
                                  </div>
                              </div>
                         </div>
                         <h6><b><i class="fa-solid fa-diamond"></i> Case grouped by status and ordered in the group</b>(<span class="n_cases">#</span> Cases)</h6>
                             <h4 class="na_h4 d-none ms-5">No data is available currently!</h4>
                         <div class="card mb-3" id="myposition_status_order">
                              <div class="card-body p-0 ps-3">
                                  <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" role="progressbar" id="rec_bar" style="background-color: #1072f1;"></div>
                                    <div class="progress-bar" role="progressbar" id="fp_bar" style="background-color: #11a9fa;"></div>
                                    <div class="progress-bar" role="progressbar" id="itv_bar" style="background-color: #2b04da;"></div>
                                    <div class="progress-bar" role="progressbar" id="rfe_bar" style="background-color: #ffe95a;"></div>
                                    <div class="progress-bar" role="progressbar" id="trf_bar" style="background-color: #c77cff;"></div>
                                    <div class="progress-bar" role="progressbar" id="apv_bar" style="background-color: #1db063;"></div>
                                    <div class="progress-bar" role="progressbar" id="rjc_bar" style="background-color: #ff001a;"></div>
                                    <div class="progress-bar" role="progressbar" id="oth_bar" style="background-color: #78787a;"></div>
                                  </div>
                                  <div class="progress bg-light"style="height: 20px;">
                                    <div class="progress-bar bg-light" role="progressbar" id="mypos_pointer" ></div>
                                      <div><i class="fa-solid fa-up-long"></i>  YOU <span id="mypos_text"></span></div>
                                  </div>
                              </div>
                         </div>
                         </div> <!-- End of my position wrapper-->
                     </div>
                 </div>
                 <!-- End of my position -->
                 <hr style="height: 0.2px;color: #ccc;max-width: 820px;">
                  <!-- Next step -->
                 <div class="row" style="max-width: 820px;">
                     <div class="col-12">
                         <h5 class="mb-3"><i class="fa-solid fa-circle-arrow-right text-primary"></i>&nbsp;<strong>Next step</strong></h5>
                     </div>
                 </div>
                 <!-- End of next step -->

                 <hr style="height: 0.2px;color: #ccc;max-width: 820px;">
                  <!-- Recent changes -->
                 <div class="row" style="max-width: 820px;">
                     <div class="col-12">
                         <h5 class="mb-3"><i class="fa-solid fa-flag text-primary"></i>&nbsp;&nbsp;<strong>Recent changes</strong></h5>
                     </div>
                 </div>
                 <!-- End of Recent changes -->

            </div> <!--col-6-->
        </div><!--row-->
    </div>
    <script src="https://d3js.org/d3.v4.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.min.js" charset="utf-8"></script>
    <script type="text/javascript" src={% static "mycase/js/saveSVG.js" %}></script>
    <script type="text/javascript" src={% static "mycase/js/lollipop.js" %}></script>
    <script type="text/javascript">
        function get_data() {
            recepit_num = $("#recepit_num").val();
            form_type = $("#form_type").val();
            range_val = $("#case_range").val();
            $("#case_in_receipt_order").empty();
            $("#lollipop_legend").empty();

            $.ajax({
              type: "GET",
              url: "ajax/caseinrange",
              async: true,
              data:{"recepit_num":recepit_num,"form_type":form_type,"case_range":range_val},
              success : function(data) {
                  n_case = data["n_cases"];
                  $(".n_cases").html(n_case);
                  if(n_case == 0){
                      $("#myposition_RN_order").addClass("d-none");
                      $("#myposition_status_order").addClass("d-none");
                      $("#donut_chart").addClass("d-none");
                      $(".na_h4").removeClass("d-none");
                  }else{
                      $(".na_h4").addClass("d-none");
                      $("#myposition_RN_order").removeClass("d-none");
                      $("#myposition_status_order").removeClass("d-none");
                      $("#donut_chart").removeClass("d-none");

                      plot_donut(data["status_counts"]);
                      draw_lollipop(recepit_num,data["status_seq"],data["status_mut"],data["status_dom"]);

                      $("#rec_bar").css('width', data["status_counts"][0] /n_case *100 + "%");
                      $("#fp_bar").css('width', data["status_counts"][1] /n_case *100 + "%");
                      $("#itv_bar").css('width', data["status_counts"][2] /n_case *100 + "%");
                      $("#rfe_bar").css('width', data["status_counts"][3] /n_case *100 + "%");
                      $("#trf_bar").css('width', data["status_counts"][4] /n_case *100 + "%");
                      $("#apv_bar").css('width', data["status_counts"][5] /n_case *100 + "%");
                      $("#rjc_bar").css('width' ,data["status_counts"][6] /n_case *100 + "%");
                      $("#oth_bar").css('width', data["status_counts"][7] /n_case *100 + "%");
                      $("#mypos_pointer").css('width', data["mypos"] + "%");

                  }

                },
              error: function() {
                      alert('Error occurs!');
                }
            });
        }
        get_data();
        function plot_donut(status_count=[100,100,100,100,100,100,100,100]) {
              let chartStatus = Chart.getChart("donut_case_percent_in_range"); // <canvas> id
               if (chartStatus != undefined) {
                  chartStatus.destroy();
               }
              var labels=["REC","FPR","ITV","RFE","TRF","APV","RJC","OTH"];

              var data = {
                  labels: labels,
                  datasets: [{
                    label: 'Cases statu count in the range',
                    data: status_count,
                    backgroundColor: ["#4e97f6","#11a9fa","#2b04da","#ffe95a","#c77cff","#1db063","#ff001a","#78787a"],
                    hoverOffset: 4
                  }]
                };

              var config = {
                  type: 'doughnut',
                  data: data,
                  options: {
                      cutout: "50%",
                      radius:"90%",
                  },
                  animation:{
                      animateScale:true
                  },
              };
              var donutChart = new Chart($('#donut_case_percent_in_range'), config
              )
        }
    </script>
 {% endblock %}